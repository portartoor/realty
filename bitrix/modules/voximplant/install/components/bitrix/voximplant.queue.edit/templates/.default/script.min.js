(function(){if(window.BX.ViGroupEdit)return;var e="/bitrix/components/bitrix/voximplant.queue.edit/ajax.php";var t={wait:"wait",talk:"talk",hungup:"hungup",pstn:"pstn",pstn_specific:"pstn_specific",user:"user",voicemail:"voicemail",queue:"queue",next_queue:"next_queue"};var i=function(e,t){this.p=!!e?e:{};if(!!e["SELECTED"]){var i={},n,o;for(n in e["SELECTED"]){if(e["SELECTED"].hasOwnProperty(n)&&typeof e["SELECTED"][n]=="object"){for(o in e["SELECTED"][n]){if(e["SELECTED"][n].hasOwnProperty(o)){if(n=="USERS")i["U"+e["SELECTED"][n][o]]="users";else if(n=="SG")i["SG"+e["SELECTED"][n][o]]="sonetgroups";else if(n=="DR")i["DR"+e["SELECTED"][n][o]]="department"}}}}this.p["SELECTED"]=i}this.nodes={};var s=function(e,t){var i={},n,o,a;if(t[e]){for(a in t[e]){if(t[e].hasOwnProperty(a)){n=t[e][a];o=[];if(t[n]&&t[n].length>0)o=s(n,t);i[n]={id:n,type:"category",items:o}}}}return i},a=function(e){var t={},i;for(var n in e){if(e.hasOwnProperty(n)){i=e[n]["parent"];if(!t[i])t[i]=[];t[i][t[i].length]=n}}return s("DR0",t)};if(true||t=="users"){this.params={name:null,searchInput:null,extranetUser:this.p["EXTRANET_USER"]=="Y",bindMainPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,callback:{select:BX.delegate(this.select,this),unSelect:BX.delegate(this.unSelect,this),openDialog:BX.delegate(this.openDialog,this),closeDialog:BX.delegate(this.closeDialog,this),openSearch:BX.delegate(this.openDialog,this),closeSearch:BX.delegate(this.closeSearch,this)},items:{users:!!this.p["USERS"]?this.p["USERS"]:{},groups:{},sonetgroups:{},department:!!this.p["DEPARTMENT"]?this.p["DEPARTMENT"]:{},departmentRelation:!!this.p["DEPARTMENT"]?a(this.p["DEPARTMENT"]):{},contacts:{},companies:{},leads:{},deals:{}},itemsLast:{users:!!this.p["LAST"]&&!!this.p["LAST"]["USERS"]?this.p["LAST"]["USERS"]:{},sonetgroups:{},department:{},groups:{},contacts:{},companies:{},leads:{},deals:{},crm:[]},itemsSelected:!!this.p["SELECTED"]?BX.clone(this.p["SELECTED"]):{},isCrmFeed:false,destSort:!!this.p["DEST_SORT"]?BX.clone(this.p["DEST_SORT"]):{}}}};i.prototype={setInput:function(e,t){if(BX.type.isDomNode(e)&&!e.hasAttribute("bx-destination-id")){var i="destination"+(""+(new Date).getTime()).substr(6),o;e.setAttribute("bx-destination-id",i);o=new n(i,e,t);this.nodes[i]=e;BX.defer_proxy(function(){this.params.name=o.id;this.params.searchInput=o.nodes.input;this.params.bindMainPopup.node=o.nodes.container;this.params.bindSearchPopup.node=o.nodes.container;BX.SocNetLogDestination.init(this.params)},this)()}},select:function(e,t,i,n,o){var s=t,a="S";if(t=="groups"){s="all-users"}else if(BX.util.in_array(t,["contacts","companies","leads","deals"])){s="crm"}if(t=="sonetgroups"){a="SG"}else if(t=="groups"){a="UA"}else if(t=="users"){a="U"}else if(t=="department"){a="DR"}else if(t=="contacts"){a="CRMCONTACT"}else if(t=="companies"){a="CRMCOMPANY"}else if(t=="leads"){a="CRMLEAD"}else if(t=="deals"){a="CRMDEAL"}var r=n?" bx-destination-undelete":"";r+=t=="sonetgroups"&&typeof window["arExtranetGroupID"]!="undefined"&&BX.util.in_array(e.entityId,window["arExtranetGroupID"])?" bx-destination-extranet":"";var d=BX.create("span",{attrs:{"data-id":e.id},props:{className:"bx-destination bx-destination-"+s+r},children:[BX.create("span",{props:{className:"bx-destination-text"},html:e.name})]});if(!n){d.appendChild(BX.create("span",{props:{className:"bx-destination-del-but"},events:{click:function(i){BX.SocNetLogDestination.deleteItem(e.id,t,o);BX.PreventDefault(i)},mouseover:function(){BX.addClass(this.parentNode,"bx-destination-hover")},mouseout:function(){BX.removeClass(this.parentNode,"bx-destination-hover")}}}))}BX.onCustomEvent(this.nodes[o],"select",[e,d,a])},unSelect:function(e,t,i,n){BX.onCustomEvent(this.nodes[n],"unSelect",[e])},openDialog:function(e){BX.onCustomEvent(this.nodes[e],"openDialog",[])},closeDialog:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeDialog",[]);this.disableBackspace()}},closeSearch:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeSearch",[]);this.disableBackspace()}},disableBackspace:function(){if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!==null)BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.bind(window,"keydown",BX.SocNetLogDestination.backspaceDisable=function(e){if(e.keyCode==8){BX.PreventDefault(e);return false}return true});setTimeout(function(){BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5e3)}};var n=function(e,t,i){this.node=t;this.id=e;this.inputName=i;this.node.appendChild(BX.create("SPAN",{props:{className:"bx-destination-wrap"},html:['<span id="',this.id,'-container"><span class="bx-destination-wrap-item"></span></span>','<span class="bx-destination-input-box" id="',this.id,'-input-box">','<input type="text" value="" class="bx-destination-input" id="',this.id,'-input">',"</span>",'<a href="#" class="bx-destination-add" id="',this.id,'-add-button"></a>'].join("")}));BX.defer_proxy(this.bind,this)()};n.prototype={bind:function(){this.nodes={inputBox:BX(this.id+"-input-box"),input:BX(this.id+"-input"),container:BX(this.id+"-container"),button:BX(this.id+"-add-button")};BX.bind(this.nodes.input,"keyup",BX.proxy(this.search,this));BX.bind(this.nodes.input,"keydown",BX.proxy(this.searchBefore,this));BX.bind(this.nodes.button,"click",BX.proxy(function(e){BX.SocNetLogDestination.openDialog(this.id);BX.PreventDefault(e)},this));BX.bind(this.nodes.container,"click",BX.proxy(function(e){BX.SocNetLogDestination.openDialog(this.id);BX.PreventDefault(e)},this));this.onChangeDestination();BX.addCustomEvent(this.node,"select",BX.proxy(this.select,this));BX.addCustomEvent(this.node,"unSelect",BX.proxy(this.unSelect,this));BX.addCustomEvent(this.node,"delete",BX.proxy(this.delete,this));BX.addCustomEvent(this.node,"openDialog",BX.proxy(this.openDialog,this));BX.addCustomEvent(this.node,"closeDialog",BX.proxy(this.closeDialog,this));BX.addCustomEvent(this.node,"closeSearch",BX.proxy(this.closeSearch,this))},select:function(e,t,i){if(!BX.findChild(this.nodes.container,{attr:{"data-id":e.id}},false,false)){t.appendChild(BX.create("INPUT",{props:{type:"hidden",name:this.inputName+"[]",value:e.entityId}}));this.nodes.container.appendChild(t)}this.onChangeDestination()},unSelect:function(e){var t=BX.findChildren(this.nodes.container,{attribute:{"data-id":""+e.id+""}},true);if(t!==null){for(var i=0;i<t.length;i++)BX.remove(t[i])}this.onChangeDestination()},onChangeDestination:function(){this.nodes.input.innerHTML="";this.nodes.button.innerHTML=BX.SocNetLogDestination.getSelectedCount(this.id)<=0?BX.message("LM_ADD1"):BX.message("LM_ADD2")},openDialog:function(){BX.style(this.nodes.inputBox,"display","inline-block");BX.style(this.nodes.button,"display","none");BX.focus(this.nodes.input)},closeDialog:function(){if(this.nodes.input.value.length<=0){BX.style(this.nodes.inputBox,"display","none");BX.style(this.nodes.button,"display","inline-block");this.nodes.input.value=""}},closeSearch:function(){if(this.nodes.input.value.length>0){BX.style(this.nodes.inputBox,"display","none");BX.style(this.nodes.button,"display","inline-block");this.nodes.input.value=""}},searchBefore:function(e){if(e.keyCode==8&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.sendEvent=false;BX.SocNetLogDestination.deleteLastItem(this.id)}return true},search:function(e){if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91)return false;if(e.keyCode==13){BX.SocNetLogDestination.selectFirstSearchItem(this.id);return true}if(e.keyCode==27){this.nodes.input.value="";BX.style(this.nodes.button,"display","inline")}else{BX.SocNetLogDestination.search(this.nodes.input.value,true,this.id)}if(!BX.SocNetLogDestination.isOpenDialog()&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.openDialog(this.id)}else if(BX.SocNetLogDestination.sendEvent&&BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}if(e.keyCode==8){BX.SocNetLogDestination.sendEvent=true}return true}};BX.ViGroupEdit=function(e){this.node=e.node;this.destinationParams=e.destinationParams;this.groupListUrl=e.groupListUrl;this.inlineMode=e.inlineMode;this.popupTooltip={};this.init()};BX.ViGroupEdit.prototype.init=function(){this.bindEvents();this.destination=new i(this.destinationParams);this.destination.setInput(BX("users_for_queue"),"USERS")};BX.ViGroupEdit.prototype.bindEvents=function(){var e=this;var i=BX.findChildrenByClassName(BX("tel-set-main-wrap"),"tel-context-help");if(BX.type.isArray(i)){i.forEach(function(t,i){t.setAttribute("data-id",i);BX.bind(t,"mouseover",function(){var t=this.getAttribute("data-id");var i=this.getAttribute("data-text");e.showTooltip(t,this,i)});BX.bind(t,"mouseout",function(){var t=this.getAttribute("data-id");e.hideTooltip(t)})})}BX.bind(BX("vi_no_answer_rule"),"change",function(e){BX.PreventDefault(e);switch(e.target.value){case t.pstn_specific:BX("vi_forward_number").style.height="55px";BX("vi_next_queue").style.height="0";break;case t.next_queue:BX("vi_forward_number").style.height="0";BX("vi_next_queue").style.height="55px";break;default:BX("vi_forward_number").style.height="0";BX("vi_next_queue").style.height="0";break}});var n=this.getNode("vi-group-edit-submit");if(n)BX.bind(n,"click",this._onSubmitClick.bind(this));var o=this.getNode("vi-group-edit-cancel");if(o)BX.bind(n,"click",this._onCancelClick.bind(this))};BX.ViGroupEdit.prototype.getNode=function(e,t){if(!t)t=this.node;return t?t.querySelector('[data-role="'+e+'"]'):null};BX.ViGroupEdit.prototype.showTooltip=function(e,t,i){if(this.popupTooltip[e])this.popupTooltip[e].close();this.popupTooltip[e]=new BX.PopupWindow("bx-voximplant-tooltip",t,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:200,events:{onPopupClose:function(){this.destroy()}},content:BX.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:i})});this.popupTooltip[e].setAngle({offset:13,position:"bottom"});this.popupTooltip[e].show();return true};BX.ViGroupEdit.prototype.hideTooltip=function(e){this.popupTooltip[e].close();this.popupTooltip[e]=null};BX.ViGroupEdit.prototype._onSubmitClick=function(t){var i=this;var n=new FormData;var o=this.node.querySelectorAll("input, select");var s;for(var a=0;a<o.length;a++){s=o.item(a);if(s.tagName.toUpperCase()=="INPUT"){switch(s.type.toUpperCase()){case"TEXT":n.append(s.name,s.value);break;case"HIDDEN":n.append(s.name,s.value);break;case"CHECKBOX":if(s.checked)n.append(s.name,s.value);break}}else if(s.tagName.toUpperCase()=="SELECT"){n.append(s.name,s.value)}}var r=this.getNode("vi-group-edit-submit");var d=BX.create("span",{props:{className:"wait"}});BX.addClass(r,"webform-small-button-wait webform-small-button-active");r.appendChild(d);BX.ajax({url:e,method:"POST",data:n,preparePost:false,onsuccess:function(e){BX.removeClass(r,"webform-small-button-wait webform-small-button-active");BX.remove(d);try{e=JSON.parse(e)}catch(t){BX.debug("Error decoding server response");return false}if(e.SUCCESS===true){if(i.inlineMode){BX.onCustomEvent(window,"onViGroupSaved",[e.DATA])}else{jsUtils.Redirect([],i.groupListUrl)}}else{alert(e.ERROR)}},onfailure:function(){BX.removeClass(r,"webform-small-button-wait webform-small-button-active");BX.remove(d);BX.debug("Failed to save group")}})};BX.ViGroupEdit.prototype._onCancelClick=function(e){BX.onCustomEvent(window,"onViGroupEditCanceled",[])}})();
//# sourceMappingURL=script.map.js