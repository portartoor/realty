var domNode=BX.create("script",{attrs:{src:"/bitrix/js/main/webrtc/adapter.js",type:"text/javascript"}});document.head.insertBefore(domNode,document.head.firstChild);var jsDetectionInProgress=false;var Module,isModuleInitialized,isBxFaceIdInitialized;if(typeof Module==="undefined"){Module={}}Module.onRuntimeInitialized=function(){isModuleInitialized=true;_BXFaceIdStart()};function BXFaceIdStart(){isBxFaceIdInitialized=true;_BXFaceIdStart()}function _BXFaceIdStart(){if(!isModuleInitialized||!isBxFaceIdInitialized){return}var e=false;var a=340;var t=0;var r=false;var s=null;var c=null;var n=null;var d=null;var o=BX.localStorage.get("faceid-default-camera");var l=null;var f=null;var u=null;var m=[];var v={};var h=new Module.WebPhotoMakerM;h.setStopAfterBestShot(true);h.setMovementThreshold(.03);h.setBestShotScoreThreshold(.05);h.setRotationThreshold(50);h.setMinFaceScaleFactor(.15);h.setMaxNumberOfFramesWithoutDetection(8);var p=a*a*4;var k=Module._malloc(p);var B=new Uint8ClampedArray(Module.HEAPU8.buffer,k,p);var g=[-1,-1,-1,-1,-1,-1];var X=["","","","","",""];function _(){navigator.mediaDevices.enumerateDevices().then(function(e){var a=document.getElementById("faceid-cameralist");var i="faceid-tracker-sidebar-photo-settings-checked";e.forEach(function(e){if(e.kind=="videoinput"){if(o==null){o=e.deviceId;BX.localStorage.set("faceid-default-camera",o,3600*24*360)}var t="faceid-tracker-sidebar-photo-settings-inner-list-item";var r=e.label.replace(/\(\w{4}:\w{4}\)/g,"");if(!r.length){r=BX.message("FACEID_TRACKER_CMP_JS_CAMERA_DEFAULT")}if(e.deviceId==o){t+=" "+i}var s=BX.create("div",{text:r,attrs:{"class":t,"data-camera-id":e.deviceId}});a.appendChild(s);BX.bind(s,"click",function(){if(BX.hasClass(BX(this),i)){return}var e,t=BX.findChildren(a);for(e in t){BX.removeClass(t[e],i)}BX.addClass(BX(this),i);o=this.getAttribute("data-camera-id");BX.localStorage.set("faceid-default-camera",o,3600*24*360);b();BX.toggle(BX("faceid-settings-container"))})}});C()}).catch(function(e){console.log(e.name+": "+e.message)})}if(window.FACEID_AGREEMENT){_()}BX.bind(BX("faceid-settings-button"),"click",function(){BX.toggle(BX("faceid-settings-container"))});function b(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;navigator.getMedia({video:{deviceId:{exact:o}},audio:false},function(e){if(navigator.mozGetUserMedia){s.mozSrcObject=e}else{var a=window.URL||window.webkitURL;s.src=a.createObjectURL(e)}s.play()},function(e){console.log("An error occured! "+e);BX.localStorage.remove("faceid-default-camera")})}function C(){s=document.getElementById("faceid-video");c=document.getElementById("faceid-canvas");d=document.getElementById("faceid-startbutton");b();f=document.getElementById("faceid-overlay-face-border");u=f.getContext("2d");s.addEventListener("canplay",function(e){if(!r){t=s.videoHeight/(s.videoWidth/a);if(isNaN(t)){t=a/(4/3)}s.setAttribute("width",a);s.setAttribute("height",t);c.setAttribute("width",a);c.setAttribute("height",t);f.setAttribute("width",a);f.setAttribute("height",t);r=true}},false);d.addEventListener("click",function(e){A();e.preventDefault()},false);if(window.FACEID_LAST_VISITORS){for(i in window.FACEID_LAST_VISITORS){F(window.FACEID_LAST_VISITORS[i],false)}}I()}function I(){requestAnimationFrame(I);if($("#faceid-auto-identify").prop("checked")==false){return}if(e){return}if(m.length){}e=true;var i=c.getContext("2d");c.width=a;c.height=t;i.drawImage(s,0,0,a,t);var r=c.toDataURL("image/jpeg",1);var n=new Image;n.onload=function(){var a=w(c,true);if(a.length>0){var i=[];for(var t in a){if(!v[a[t].frameId]&&h.getBestShotFrameNumber(a[t].frameId)>=0&&h.getCurrentFrameNumber()>=h.getBestShotFrameNumber(a[t].frameId)){i.push(a[t])}}if(i.length){M(i,n)}}e=false};n.onerror=function(){e=false};n.src=r;requestAnimationFrame(I)}function T(e){for(var a=0;a<g.length;a++){var i=0;for(var t=0;t<e.length;t++){if(e[t]!=g[a])i++;else break}if(i==e.length){g[a]=-1;X[a]=""}}for(var t=0;t<e.length;t++){var r=true;for(var a=0;a<g.length;a++){if(e[t]==g[a]){r=false;break}}if(r){for(var a=0;a<g.length;a++){if(g[a]==-1){g[a]=e[t];break}}}}}function x(e,a,i,t,r){e.save();e.strokeStyle="rgba("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")";e.lineWidth=3;try{var s=a.x;var c=a.y;var n=a.x+a.width;var d=a.y+a.height;var o=i;var l=Math.PI/180;if(n-s-2*o<0){o=(n-s)/2}if(d-c-2*o<0){o=(d-c)/2}e.beginPath();e.moveTo(s+o,c);e.lineTo(n-o,c);e.arc(n-o,c+o,o,l*270,l*360,false);e.lineTo(n,d-o);e.arc(n-o,d-o,o,l*0,l*90,false);e.lineTo(s+o,d);e.arc(s+o,d-o,o,l*90,l*180,false);e.lineTo(s,c+o);e.arc(s+o,c+o,o,l*180,l*270,false);e.closePath();e.font="bold 11px opensans";e.fillStyle="#91ff4f";var f="";if(v[r]){f=v[r].name}e.fillText(f.toUpperCase(),s,c-5);e.stroke();e.restore()}catch(u){console.log("BAD VALUE OF DETECTION");console.log(u)}}function A(e){if(!e){var i=c.getContext("2d");c.width=a;c.height=t;i.drawImage(s,0,0,a,t);e=c.toDataURL("image/jpeg",1)}var r=new Image;r.onload=function(){var e=true;if(e){var a=w(c);M(a,r)}else{E(r.getAttribute("src"))}};r.src=e}function w(e,i){var r=[];var c=e.getContext("2d");e.width=a;e.height=t;c.drawImage(s,0,0,a,t);var n=e;var d=n.getContext("2d");var o=d.getImageData(0,0,a,t);B.set(o.data,0);h.submitRawImage(k,a,t);h.update();u.clearRect(0,0,f.width,f.height);var l=h.getIds();var v=JSON.parse(l);var p=v["ids"];T(p);if(p.length){for(var g=0;g<p.length;g++){var X=p[g];var _=h.getSmoothedFaceDetection(X);var b=h.faceDetectionIsPredicted(X);var C=[145,255,79,255];var I="";var A=h.isSlowMovement(X);if(!A)I="TOO FAST!!!";if(b)I="PREDICT";if(b||!A){C=[255,0,0,255]}x(u,_,10,C,X);if(m.indexOf(X)==-1){r.push({frameId:X,width:_.width,height:_.height,positionX:_.x,positionY:_.y})}}}if(!i){S()}return r}function S(){requestAnimationFrame(function(){requestAnimationFrame(function(){h.reset();u.clearRect(0,0,f.width,f.height)})})}function M(e,a){var t=false;if(e.length>0){for(i=0;i<e.length;i++){{var r=e[i];var s=document.createElement("canvas");s.setAttribute("width",100);s.setAttribute("height",100);var c=s.getContext("2d");var n=.6;var d=Math.max(0,r.positionX-r.width*n/2);var o=Math.max(0,r.positionY-r.height*n/2);var l=r.width+r.width*n;var f=r.height+r.height*n;var u=100;var m=100;var v=0;var h=0;c.drawImage(a,d,o,l,f,v,h,u,m);var p=s.toDataURL("image/jpeg");E(p,r.frameId);t=true}}}if(!t){E(a.src,false,true)}}function E(e,a,i){BX.addClass(BX("faceid-tracker-main-user-start-block"),"faceid-tracker-animate-hidden");var t=BX.create("div",{attrs:{"class":"faceid-tracker-main-user-item faceid-tracker-first-item"}});t.innerHTML='<div class="faceid-tracker-main-user-photo"> 					<div class="faceid-tracker-main-user-photo-platform"> 						<span class="faceid-tracker-main-user-photo-platform-item">CRM</span> 					</div> 					<div class="faceid-tracker-main-user-photo-item"> 						<img width="100" height="100"> 					</div> 					<div class="faceid-tracker-main-user-photo-count"> 						<span class="faceid-tracker-main-user-photo-count-item">58%</span> 						<div class="faceid-tracker-main-user-photo-count-info"> 							<div class="faceid-tracker-main-user-photo-count-info-desc"></div> 							<div class="faceid-tracker-main-user-photo-item"></div> 						</div> 					</div> 				</div> 				<div class="faceid-tracker-main-user-info"> 					<div class="faceid-tracker-user-loader"> 						<div class="faceid-tracker-user-loader-item"> 							<div class="faceid-tracker-loader"> 								<svg class="faceid-tracker-circular" viewBox="25 25 50 50"> 									<circle class="faceid-tracker-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/> 								</svg> 							</div> 						</div> 					</div> 				</div>';BX.prepend(t,BX("faceid-tracker-main-user-container"));var r=20;var s=BX.findChildren(BX("faceid-tracker-main-user-container"),{"class":"faceid-tracker-main-user-item"});if(s.length>r){l=s[s.length-2].getAttribute("data-last-visit-ts");var c=s[s.length-1];c.remove()}var n=BX.findChild(t,{"class":"faceid-tracker-main-user-photo-item"},true);var d=BX.findChild(n,{tag:"img"});d.setAttribute("src",e);if(i){BX.addClass(t,"faceid-tracker-user-warning");var o=BX.findChild(t,{"class":"faceid-tracker-main-user-info"},true);o.innerHTML='<div class="faceid-tracker-main-user-info-name"> 				<div class="faceid-tracker-main-user-info-name-warning">'+BX.message("FACEID_TRACKER_CMP_JS_FACE_NOT_FOUND")+"</div> 			</div>"}else{var f=a>=0?a:"faceid-ajax-unique-"+Math.random();y(f);BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax.php",method:"POST",data:{action:"identify",image:e},dataType:"json",processData:false,start:true,onsuccess:function(i){R(f);if(i.length){var r=JSON.parse(i);var s=r.visitor;s.image_src=s.shot_src;s.shot_src=e;var c=O(t,s);if(a>=0){v[a]={name:s.name}}if(c){N(s)}if(r.status&&r.status.balance>=0){BX("faceid-credits-balance").innerText=r.status.balance}}else{h.discardBestShot(a);BX.addClass(t,"faceid-tracker-user-warning");var n=BX.findChild(t,{"class":"faceid-tracker-main-user-info"},true);n.innerHTML='<div class="faceid-tracker-main-user-info-name"> 							<div class="faceid-tracker-main-user-info-name-warning">'+BX.message("FACEID_TRACKER_CMP_JS_FACE_NOT_FOUND")+"</div> 						</div>"}},onfailure:function(){R(f);h.discardBestShot(a)}})}}function y(e){m.push(e)}function R(e){var a=m.indexOf(e);if(a>-1){m.splice(a,1)}}function F(e,a){BX.addClass(BX("faceid-tracker-main-user-start-block"),"faceid-tracker-animate-hidden");var i=BX.create("div",{attrs:{"class":"faceid-tracker-main-user-item faceid-tracker-first-item"}});var t=O(i,e);BX.prepend(i,BX("faceid-tracker-main-user-container"));if(e.last_visit_ts<l||l==null){l=e.last_visit_ts}if(t){N(e,a)}}function D(e,a){BX.addClass(BX("faceid-tracker-main-user-start-block"),"faceid-tracker-animate-hidden");var i=BX.create("div",{attrs:{"class":"faceid-tracker-main-user-item faceid-tracker-first-item"}});var t=O(i,e);if(BX("faceid-tracker-main-user-more")){BX("faceid-tracker-main-user-container").insertBefore(i,BX("faceid-tracker-main-user-more"))}else{BX.append(i,BX("faceid-tracker-main-user-container"))}if(e.last_visit_ts<l||l==null){l=e.last_visit_ts}if(t){N(e,a)}}function N(e,a){a=typeof a!=="undefined"?a:true;BX("faceid-stats-current-count").innerText=parseInt(BX("faceid-stats-current-count").innerText)+1;if(a){if(e.visits_count<=1){BX("faceid-stats-new-count").innerText=parseInt(BX("faceid-stats-new-count").innerText)+1}else{BX("faceid-stats-old-count").innerText=parseInt(BX("faceid-stats-old-count").innerText)+1}BX("faceid-stats-total-count").innerText=parseInt(BX("faceid-stats-total-count").innerText)+1;if(e.crm_url.length){BX("faceid-stats-crm-count").innerText=parseInt(BX("faceid-stats-crm-count").innerText)+1}}}function O(e,a){var i=true;var t=typeof a=="string"?JSON.parse(a):a;e.setAttribute("data-visitor-id",t.visitor_id);var r=BX.findChildren(BX("faceid-tracker-main-user-container"),{attr:{"data-visitor-id":t.visitor_id}});if(r){var s;for(s in r){if(r[s]!=e){r[s].remove();i=false}}}if(t.confidence>0){BX.addClass(e,"faceid-tracker-photo")}if(t.crm_url.length>0){BX.addClass(e,"faceid-tracker-platform")}if(t.vk_id.length>0){BX.addClass(e,"faceid-tracker-social-state")}e.setAttribute("data-last-visit-ts",t.last_visit_ts);var c='<div class="faceid-tracker-main-user-photo"> 						<div class="faceid-tracker-main-user-photo-platform"> 							<span class="faceid-tracker-main-user-photo-platform-item">CRM</span> 						</div> 						<div class="faceid-tracker-main-user-photo-item"> 							<img width="100" height="100"> 						</div> 						<div class="faceid-tracker-main-user-photo-count"> 							<span class="faceid-tracker-main-user-photo-count-item">'+t.confidence+'%</span> 							<div class="faceid-tracker-main-user-photo-count-info"> 								<div class="faceid-tracker-main-user-photo-count-info-desc">'+BX.message("FACEID_TRACKER_CMP_JS_FACE_ORIGINAL")+'</div> 								<div class="faceid-tracker-main-user-photo-item" style="background-image: url('+t.image_src+')"></div> 							</div> 						</div> 					</div> 					<div class="faceid-tracker-main-user-info"> 						<div class="faceid-tracker-main-user-info-description"> 							<span class="faceid-tracker-main-user-info-description-item">'+t.visit_info+'</span> 						</div> 						<div class="faceid-tracker-main-user-info-name">';if(t.crm_url.length)c+='<a href="'+t.crm_url+'" class="faceid-tracker-main-user-info-name-item">'+t.name+"</a>";else c+='<div class="faceid-tracker-main-user-info-name-item">'+t.name+"</div>";c+='						</div> 						<div class="faceid-tracker-main-user-info-control">';if(!t.crm_url.length)c+='							<div class="faceid-tracker-main-user-info-control-block'+(t.crm_url.length?" faceid-tracker-button-state":"")+'"> 								<div class="webform-small-button webform-small-button-blue faceid-tracker-main-user-info-control-button">'+BX.message("FACEID_TRACKER_CMP_JS_SAVE_CRM")+' 									<div class="faceid-tracker-user-loader"> 										<div class="faceid-tracker-user-loader-item"> 											<div class="faceid-tracker-loader"> 												<svg class="faceid-tracker-circular" viewBox="25 25 50 50"> 													<circle class="faceid-tracker-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/> 												</svg> 											</div> 										</div> 									</div> 								</div> 								<div class="webform-small-button webform-small-button-transparent faceid-tracker-main-user-info-control-button">'+BX.message("FACEID_TRACKER_CMP_JS_SAVE_CRM_DONE")+"</div> 							</div>";c+='							<div class="faceid-tracker-main-user-info-control-social"> 								<span class="faceid-tracker-main-user-info-control-social-name">'+BX.message("FACEID_TRACKER_CMP_JS_VK_LINK")+"</span>";if(t.vk_id.length)c+='									<a href="http://vk.com/'+BX.util.htmlspecialchars(t.vk_id)+'" class="faceid-tracker-main-user-info-control-social-item">'+"VK.com/"+BX.util.htmlspecialchars(t.vk_id)+"</a>";else c+='									<span class="faceid-tracker-main-user-info-control-social-item"><span>'+BX.message("FACEID_TRACKER_CMP_JS_VK_LINK_ACTION")+"</span></span>";c+="							</div> 						</div> 					</div>";e.innerHTML=c;var n=BX.findChild(e,{"class":"faceid-tracker-main-user-photo-item"},true);var d=BX.findChild(n,{tag:"img"});d.setAttribute("src",t.shot_src);if(!t.vk_id.length){var o=BX.clone(BX("faceid-tracker-profile-search-example"));o.id="";o.style.top=document.body.scrollTop+596+30+"px";var l=BX.findChild(e,{"class":"faceid-tracker-main-user-info-control-social-item"},true);var f=BX.findChild(o,{"class":"faceid-tracker-profile-search-header"},true);var u=0;var m=0;var v=function(e){var a=u-e.clientX;var i=m-e.clientY;o.style.left=parseInt(o.style.left)-a+"px";o.style.top=parseInt(o.style.top)-i+"px";u=e.clientX;m=e.clientY};var h=function(){BX.unbind(document,"mousemove",v);BX.unbind(document,"mouseup",h)};BX.bind(f,"mousedown",function(e){var a=BX.pos(o);o.style.left=a.left+"px";o.style.top=a.top+"px";u=e.clientX;m=e.clientY;o.style.transform="translate(0)";BX.bind(document,"mousemove",v);BX.bind(document,"mouseup",h)});document.body.appendChild(o);var p=BX.findChild(l,{tag:"span"});BX.bind(p,"click",function(){if(o.getAttribute("data-in-progress")){return}o.setAttribute("data-in-progress","1");BX.show(o);BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_vk.php",method:"POST",data:{action:"identify",image:t.shot_src,visitor_id:t.visitor_id},dataType:"json",processData:false,start:true,onsuccess:function(a){var i=JSON.parse(a);var r=i.items;if(i.status&&i.status.balance>=0){BX("faceid-credits-balance").innerText=i.status.balance}if(r.length){var s,c="";c=L(r[0],true);var n=BX.findChild(o,{"class":"faceid-tracker-profile-search-main"},true);n.innerHTML=c+n.innerHTML;c="";r.splice(0,1);for(s in r){c+=L(r[s])}n=BX.findChild(o,{"class":"faceid-tracker-profile-search-found-container"},true);n.innerHTML=c;var d=BX.findChild(o,{"class":"faceid-tracker-profile-search-found-more-count"},true);d.innerHTML=r.length+" "+BX.message("FACEID_TRACKER_CMP_JS_VK_FOUND_PEOPLE");var f=BX.findChild(o,{"class":"faceid-tracker-profile-search-loading"},true);BX.addClass(f,"faceid-tracker-animate-hidden");var u=BX.findChildren(o,{"class":"faceid-tracker-main-user-info-control-button"},true);for(s in u){BX.bind(u[s],"click",function(){var a=BX(this).parentNode.parentNode;var i=BX.findChild(a,{"class":"faceid-tracker-main-user-social-link-item"},true).innerText;var r=l.parentNode;l.remove();r.innerHTML+='<a href="http://'+i+'" class="faceid-tracker-main-user-info-control-social-item">'+i.replace("vk.com","VK.com")+"</a>";BX.addClass(e,"faceid-tracker-social-state");BX.hide(o);BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_vk.php",method:"POST",data:{action:"save",vk_id:i.replace("vk.com/",""),visitor_id:t.visitor_id},dataType:"json",processData:false,start:true,onsuccess:function(a){var i=JSON.parse(a);var r=BX.findChild(e,{"class":"faceid-tracker-main-user-info-name"},true);r.innerHTML='<a href="'+i.url+'" class="faceid-tracker-main-user-info-name-item">'+t.name+"</a>"}})})}}}})});var k=BX.findChild(o,{"class":"faceid-tracker-header-description-close-item"},true);BX.bind(k,"click",function(){BX.hide(o)})}var B=BX.findChild(e,{"class":"webform-small-button-blue"},true);BX.bind(B,"click",function(){var a=BX(this).parentNode;if(!BX.hasClass(a,"faceid-tracker-button-state")&&!BX.hasClass(a,"faceid-control-loader-state")){BX.addClass(a,"faceid-control-loader-state");BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_crm.php",method:"POST",data:{action:"addLead",lead_title:t.name,visitor_id:t.visitor_id},dataType:"json",processData:false,start:true,onsuccess:function(i){var r=JSON.parse(i);var s=BX.findChild(e,{"class":"faceid-tracker-main-user-info-name"},true);s.innerHTML='<a href="'+r.url+'" class="faceid-tracker-main-user-info-name-item">'+t.name+"</a>";BX.removeClass(a,".faceid-control-loader-state");BX.addClass(a,"faceid-tracker-button-state")}})}});return i}function L(e,a){var i='<div class="faceid-tracker-main-user-item faceid-tracker-profile-search-found faceid-tracker-photo'+(a?" faceid-tracker-found-user":"")+'"> 					<div class="faceid-tracker-main-user-photo"> 						<div class="faceid-tracker-main-user-photo-platform"> 							<span class="faceid-tracker-main-user-photo-platform-item">CRM</span> 						</div> 						<div class="faceid-tracker-main-user-photo-item" style="background-image: url('+BX.util.htmlspecialchars(e.photo)+')"></div> 						<div class="faceid-tracker-main-user-photo-count"> 							<span class="faceid-tracker-main-user-photo-count-item">'+Math.round(e.confidence*100)+'%</span> 						</div> 					</div> 					<div class="faceid-tracker-main-user-info"> 						<div class="faceid-tracker-main-user-info-name"> 							<div class="faceid-tracker-main-user-info-name-item">'+BX.util.htmlspecialchars(e.name)+'</div> 							<div class="faceid-tracker-main-user-date"> 								<span class="faceid-tracker-main-user-date-item">'+BX.util.htmlspecialchars(e.personal)+'</span> 							</div> 							<div class="faceid-tracker-main-user-social-link"> 								<a href="http://vk.com/'+BX.util.htmlspecialchars(e.id)+'" class="faceid-tracker-main-user-social-link-item">vk.com/'+BX.util.htmlspecialchars(e.id)+'</a> 							</div> 						</div> 						<div class="faceid-tracker-main-user-info-control"> 							<div class="webform-small-button webform-small-button-blue faceid-tracker-main-user-info-control-button '+(a?"":"faceid-tracker-search-button")+'">'+BX.message("FACEID_TRACKER_CMP_JS_VK_SELECT")+"</div> 						</div> 					</div> 				</div>";return i}BX.ready(function(){BX.bind(BX("faceid-tracker-main-user-more"),"click",function(){if(!l){return}BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_more.php",method:"POST",data:{last:l},dataType:"json",processData:false,start:true,onsuccess:function(e){var a,i=JSON.parse(e);if(i.length){for(a in i){D(i[a],false)}}else{BX("faceid-tracker-main-user-more").remove()}}})});BX.bind(BX("faceid-tracker-header-description-close"),"click",function(){BX.localStorage.set("faceid-description-read","1",3600*24*360);BX(this).parentNode.remove()});if(!BX.localStorage.get("faceid-description-read")){BX.show(BX("faceid-tracker-header-description-close").parentNode)}BX.bind(BX("faceid-auto-identify"),"change",function(){if(!BX(this).checked){S()}})})}
//# sourceMappingURL=script.map.js