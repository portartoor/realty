(function(){if(window.CrmActivityEmailView)return;CrmActivityEmailView=function(i,t){var e=this;e.id=i;e.options=t;if(e.options.pageSize<1||e.options.pageSize>100)e.options.pageSize=5;e.primaryNode=BX("crm-activity-email-details-"+e.id);e.wrapper=e.primaryNode.parentNode;e.log={a:1,b:1};e.scrollWrapper(e.primaryNode.offsetTop-e.wrapper.offsetTop);var a=BX.findChildByClassName(e.wrapper,"crm-task-list-mail-more-a",true);if(a){BX.bind(a,"click",function(i){e.loadLog(i,this,"a");return false})}var r=BX.findChildByClassName(e.wrapper,"crm-task-list-mail-more-b",true);if(r){BX.bind(r,"click",function(i){e.loadLog(i,this,"b");return false})}var l=BX.findChildrenByClassName(e.wrapper,"crm-task-list-mail-item",true);for(var s in l){BX.bind(l[s],"click",function(i){e.toggleLogItem(i,this)})}};CrmActivityEmailView.prototype.scrollWrapper=function(i){var t=this;if(t.wrapper.animation){clearInterval(t.wrapper.animation);t.wrapper.animation=null}var e=t.wrapper.scrollTop;var a=i-e;var r=0;t.wrapper.animation=setInterval(function(){r++;t.wrapper.scrollTop=e+a*r/8;if(r>=8){clearInterval(t.wrapper.animation);t.wrapper.animation=null}},20)};CrmActivityEmailView.prototype.loadLog=function(i,t,e){var a=this;i=i||window.event;i.preventDefault();var r=t.parentNode;BX.ajax({method:"POST",url:a.options.ajaxUrl,data:{act:"log",id:a.id,log:e+(1+a.log[e]),size:a.options.pageSize},dataType:"json",onsuccess:function(i){if(i.result!="error"){a.log[e]++;var l=document.createElement("DIV");l.innerHTML=i.html;var s=e=="a"?BX.findNextSibling(r,{tag:"div"}):r;while(l.childNodes.length>0){var o=r.parentNode.insertBefore(l.childNodes[0],s);if(o.nodeType==1&&BX.hasClass(o,"crm-task-list-mail-item")){BX.bind(o,"click",function(i){a.toggleLogItem(i,this)})}}var n=BX.findChildrenByClassName(a.wrapper,"crm-task-list-mail-item",true);for(var m in n){if(BX.hasClass(n[m],"crm-task-list-mail-item-open")){var p=n[m].getAttribute("data-id");var c=BX.findNextSibling(n[m],{"class":"crm-activity-email-details-"+p});var d=BX.findPreviousSibling(n[m],{tag:"div"});if(d&&BX.hasClass(d,"crm-task-list-mail-item-separator"))BX.show(d,"block");var f=BX.findNextSibling(c,{tag:"div"});if(f&&BX.hasClass(f,"crm-task-list-mail-item-separator"))BX.show(f,"block")}}if(i.count<a.options.pageSize){if(e=="a")r.removeChild(t);else r.parentNode.removeChild(r)}if(e=="b")a.scrollWrapper(a.wrapper.scrollHeight);l.innerHTML=""}}})};CrmActivityEmailView.prototype.toggleLogItem=function(i,t){var e=this;if(window.getSelection){if(window.getSelection().toString().trim()!="")return}else if(document.selection){if(document.selection.createRange().htmlText.trim()!="")return}i=i||window.event;i.preventDefault();var a=t.getAttribute("data-id");var r=BX.findNextSibling(t,{"class":"crm-activity-email-details-"+a});var l=BX.hasClass(t,"crm-task-list-mail-item-open");if(r){BX.toggleClass(t,"crm-task-list-mail-item-open");if(l){var s=BX.findPreviousSibling(t,{tag:"div"});if(s&&BX.hasClass(s,"crm-task-list-mail-item-separator")){var o=BX.findPreviousSibling(s,{tag:"div"});if(o&&BX.hasClass(o,"crm-task-list-mail-item-inner")&&o.offsetHeight==0)BX.hide(s,"block")}var n=BX.findNextSibling(r,{tag:"div"});if(n&&BX.hasClass(n,"crm-task-list-mail-item-separator")){var m=BX.findNextSibling(n,{tag:"div"});if(m&&BX.hasClass(m,"crm-task-list-mail-item")&&m.offsetHeight>0)BX.hide(n,"block")}r.style.display="none";t.style.display=""}else{var s=BX.findPreviousSibling(t,{tag:"div"});if(s&&BX.hasClass(s,"crm-task-list-mail-item-separator"))BX.show(s,"block");var n=BX.findNextSibling(r,{tag:"div"});if(n&&BX.hasClass(n,"crm-task-list-mail-item-separator"))BX.show(n,"block");r.style.display="";if(r.getAttribute("data-empty")){if(r.offsetTop+r.offsetHeight-e.wrapper.offsetTop-e.wrapper.scrollTop>e.wrapper.offsetHeight)e.scrollWrapper(r.offsetTop+r.offsetHeight-e.wrapper.offsetTop-e.wrapper.offsetHeight);BX.ajax({method:"POST",url:e.options.ajaxUrl,data:{act:"logitem",id:a},dataType:"json",onsuccess:function(i){if(i.result!="error"){r.style.textAlign="";r.innerHTML=i.html;t.style.display="none";var a=BX.findChildByClassName(r,"crm-task-list-mail-item-inner-header",true);BX.bind(a,"click",function(i){e.toggleLogItem(i,t)});r.removeAttribute("data-empty")}else{r.innerHTML=i.error}}})}else{t.style.display="none"}}}};window.CrmActivityEmailView=CrmActivityEmailView})();
//# sourceMappingURL=script.map.js