BX.namespace("Crm.Component");if(typeof BX.Crm.Component.FormRecurring==="undefined"){BX.Crm.Component.FormRecurring=function(){this.prevPeriod=null;this.selectorMail=null;this.context=null;this.templateUrl=null;this.typeId=null;this.existUserMail=null;this.constants={PERIOD_DAILY:1,PERIOD_WEEKLY:2,PERIOD_MONTHLY:3,PERIOD_YEARLY:4,REPEAT_TILL_ENDLESS:"endless",REPEAT_TILL_TIMES:"times",REPEAT_TILL_DATE:"date",MONDAY:1,TUESDAY:2,THURSDAY:4,SUNDAY:7};this.construct=function(e){if(BX.type.isElementNode(BX("datepicker-display-start"))){BX.CrmDateLinkField.create(BX("datepicker-display-start"),null,{showTime:false,setFocusOnShow:false});BX("datepicker-display-start").setAttribute("readonly","readonly")}if(BX.type.isElementNode(BX("datepicker-display-start"))){BX.CrmDateLinkField.create(BX("datepicker-display-end"),null,{showTime:false,setFocusOnShow:false});BX("datepicker-display-end").setAttribute("readonly","readonly")}this.existUserMail=e.ALLOW_SEND_BILL=="Y";this.context=e.CONTEXT||"";this.templateUrl=e.TEMPLATE_URL||"";this.typeId=e.ENTITY_TYPE_ID||5;if(e.EMAILS[0]!==undefined){this.createEmailSelection(e.EMAILS)}this.prevPeriod=this.getValueString("period");this.onUpdateHint();this.bindEvents();this.onPeriodChange()};this.createEmailSelection=function(e){var t=BX("crm-recur-email-change");this.selectorMail=BX.CmrSelectorMenu.create("selector_recurring_email",{container:t,items:e});this.selectorMail.addOnSelectListener(BX.delegate(this.onTypeSelect,this));BX.bind(t,"click",BX.delegate(function(){this.selectorMail.open(t)},this))};this.toggleMailSender=function(){if(!this.existUserMail){BX("crm-recurring-email").checked="";BX("crm-recurring-email").disabled="disabled";BX("crm-recurring-email").classList.add("crm-recur-checkbox-blocked");BX("crm-recurring-empty-owner-email").classList.add("crm-recurring-empty-owner-email")}else{BX("crm-recurring-email").disabled="";BX("crm-recurring-email").classList.remove("crm-recur-checkbox-blocked");BX("crm-recurring-empty-owner-email").innerHTML="";BX("crm-recurring-empty-owner-email").classList.remove("crm-recurring-empty-owner-email")}};this.changeClientData=function(e,t){var a=[];var i;if(e.getId()==="UF_MYCOMPANY_ID"){i=t.primaryEntityInfo.getMultiFieldsByType("EMAIL");if(!t.primaryEntityInfo||i[0]==undefined){this.existUserMail=false}else{this.existUserMail=true}this.toggleMailSender()}else if(e.getId()==="CLIENT"){if(t.entityInfos instanceof Array&&t.primaryEntityTypeName=="COMPANY"){t.entityInfos.forEach(function(e){i=e.getMultiFieldsByType("EMAIL");if(i[0]!==undefined){a.push({text:i[0].VALUE,value:i[0].ENTITY_ID})}})}if(t.primaryEntityInfo){i=t.primaryEntityInfo.getMultiFieldsByType("EMAIL");if(i[0]!==undefined){a.push({text:i[0].VALUE,value:i[0].ID})}this.createEmailSelection(a);if(a[0]!==undefined){BX.removeClass(BX("crm-recur-email-block"),"crm-recur-invisible");BX("crm-recur-client-email-value").innerHTML=a[0].text;BX("crm-recur-client-email-input").value=a[0].value}else{BX.addClass(BX("crm-recur-email-block"),"crm-recur-invisible");BX("crm-recurring-email").checked=""}}else{BX.addClass(BX("crm-recur-email-block"),"crm-recur-invisible");BX("crm-recurring-email").checked=""}}};this.onTypeSelect=function(e,t){BX("crm-recur-client-email-value").innerHTML=t.getText();BX("crm-recur-client-email-input").value=t.getValue()};this.bindInstantChange=function(e,t,a){if(!BX.type.isElementNode(e)){return BX.DoNothing}a=a||e;var i=e.value;var n=BX.debounce(function(n){if(e.value.toString()!=i.toString()){t.apply(a,arguments);i=e.value}},3,a);BX.bind(e,"input",n);BX.bind(e,"keyup",n);BX.bind(e,"change",n)};this.bindEvents=function(){var e=BX.delegate(this.onUpdateHint,this);var t=BX.delegate(this.onChangeNumDay,this);var a=BX.delegate(this.moreNullValue,this);BX.addCustomEvent("RecurringInvoiceClientDataList",BX.delegate(function(e,t){this.changeClientData(e,t)},this));BX.bind(BX("crm-recur-create-mail-template-link"),"click",BX.delegate(function(){this.onMailTemplateCreateClick()},this));BX.bind(BX("crm-recurring-flag"),"click",BX.delegate(function(e){if(e.target.checked){BX.removeClass(BX("crm-recur-edit-recurring-panel"),"crm-recur-invisible")}else{BX.addClass(BX("crm-recur-edit-recurring-panel"),"crm-recur-invisible")}},this));BX.bind(BX("crm-recurring-email").parentNode,"click",BX.delegate(function(){if(!this.existUserMail){BX("crm-recurring-empty-owner-email").innerHTML=BX.message("CRM_RECURRING_EMPTY_OWNER_EMAIL")}else if(BX("crm-recurring-empty-owner-email").innerHTML!=""){BX("crm-recurring-empty-owner-email").innerHTML=""}},this));BX.bindDelegate(BX("period-type-selector"),"click",{className:"period-type-option"},BX.proxy(function(e){this.onSetPeriodValue(e.target)},this));BX.bindDelegate(BX("crm-recur-edit-replication-block"),"change",{tag:"select"},e);BX.bindDelegate(BX("crm-recur-edit-replication-block"),"change",{tag:"input",attr:{type:"checkbox"}},e);BX.bindDelegate(BX("crm-recur-edit-replication-block"),"change",{tag:"input",attr:{type:"radio"}},e);this.bindInstantChange(BX("daily-interval-day"),e);this.bindInstantChange(BX("daily-interval-month"),e);this.bindInstantChange(BX("weekly-interval-week"),e);BX.bind(BX("monthly-day-num"),"change",t);this.bindInstantChange(BX("monthly-day-num"),e);this.bindInstantChange(BX("monthly-month-num-1"),e);this.bindInstantChange(BX("monthly-month-num-2"),e);this.bindInstantChange(BX("yearly-day-num"),e);BX.bind(BX("yearly-interval-day"),"change",t);BX.bind(BX("yearly-month-1"),"change",t);this.bindInstantChange(BX("yearly-interval-day"),e);this.bindInstantChange(BX("daily-interval-day"),a);this.bindInstantChange(BX("monthly-month-num-1"),a);this.bindInstantChange(BX("monthly-month-num-2"),a);this.bindInstantChange(BX("weekly-interval-week"),a);this.bindInstantChange(BX("end-times"),e);this.bindInstantChange(BX("datepicker-display-start"),e);this.bindInstantChange(BX("datepicker-display-end"),e);this.toggleMailSender()};this.onMailTemplateCreateClick=function(){var e=this.templateUrl;var t=(this.context+"_"+BX.util.getRandomString(6)).toLowerCase();if(e===""||t===""){return}t=(t+"_"+BX.util.getRandomString(6)).toLowerCase();var a={external_context:t};e=BX.util.add_url_param(e,a);if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[t]={context:t,wnd:window.open(e)};if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}};this.onExternalEvent=function(e){if(this._readOnly){return}var t=BX.type.isNotEmptyString(e["key"])?e["key"]:"";var a=BX.type.isPlainObject(e["value"])?e["value"]:{};var i=BX.type.isNotEmptyString(a["context"])?a["context"]:"";if(t==="onCrmMailTemplateCreate"&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[i])){if(a.entityType==this.typeId){var n=BX.create("option",{props:{id:a.templateId,text:a.templateTitle}});BX("email_template").appendChild(n);if(BX("email_template").disabled){BX("email_template").removeAttribute("disabled");BX("email_template").parentNode.classList.remove("disabled")}}if(this._externalRequestData[i]["wnd"]){this._externalRequestData[i]["wnd"].close()}delete this._externalRequestData[i]}};this.getCurrentPeriod=function(){return this.getValueString("period")};this.moreNullValue=function(e){e.target.value=e.target.value>0?parseInt(e.target.value):1};this.onSetPeriodValue=function(e){var t=BX.data(e,"type");if(BX.util.in_array(t,[this.constants.PERIOD_DAILY,this.constants.PERIOD_WEEKLY,this.constants.PERIOD_MONTHLY,this.constants.PERIOD_YEARLY])){var a=BX.findChildrenByClassName(e.parentNode,"active-recur");if(a[0]){BX.removeClass(a[0],"active-recur")}BX.addClass(e,"active-recur");BX("period").value=t;this.onPeriodChange()}};this.getDays=function(e){return e===2?28:30+(e>7?e+1:e)%2};this.onChangeNumDay=function(){var e=this.getCurrentPeriod();if(e==3){t=31;target=BX("monthly-day-num")}else if(e==4){month=this.getValueInt("yearly-month-1");var t=this.getDays(month);target=BX("yearly-interval-day")}var a=parseInt(target.value);if(a<=0||isNaN(a)){target.value=1}else if(a>t){target.value=t}else{target.value=a}};this.setConstraintPanelHeight=function(e){var t=BX("panel-"+e);if(t){var a=BX.pos(t).height;BX("panel").style.height=a+"px"}};this.onPeriodChange=function(){var e=this.getCurrentPeriod();if(this.prevPeriod!=e){var t=BX("panel-period-"+this.prevPeriod);var a=BX("panel-period-"+e);if(t&&a){this.setConstraintPanelHeight(this.prevPeriod);BX.addClass(t,"nodisplay");BX.removeClass(a,"nodisplay");this.setConstraintPanelHeight(e);this.prevPeriod=e}}this.onUpdateHint()};this.onUpdateHint=function(){var e=BX("hint");if(!e){return}var t={PERIOD:this.getValueString("period"),EVERY_DAY:this.getValueInt("daily-interval-day"),WORKDAY_ONLY:this.getSelectedControlValues("workday-only-select"),DAILY_MONTH_INTERVAL:this.getValueInt("daily-interval-month"),EVERY_WEEK:this.getValueInt("weekly-interval-week"),WEEK_DAYS:this.getWeekDays(),MONTHLY_DAY_NUM:this.getValueInt("monthly-day-num"),MONTHLY_MONTH_NUM_1:this.getValueInt("monthly-month-num-1"),MONTHLY_WORKDAY_ONLY:this.getSelectedControlValues("monthly-only-select"),MONTHLY_TYPE:this.getSelectedControlValues("monthly-type")[0],MONTHLY_WEEK_DAY_NUM:this.getValueInt("monthly-week-day-num"),MONTHLY_WEEK_DAY:this.getValueInt("monthly-week-day"),MONTHLY_MONTH_NUM_2:this.getValueInt("monthly-month-num-2"),YEARLY_TYPE:this.getSelectedControlValues("yearly-type")[0],YEARLY_DAY_NUM:this.getValueInt("yearly-interval-day"),YEARLY_MONTH_1:this.getValueInt("yearly-month-1"),YEARLY_WEEK_DAY_NUM:this.getValueInt("yearly-week-day-num"),YEARLY_WORKDAY_ONLY:this.getSelectedControlValues("yearly-only-select"),YEARLY_WEEK_DAY:this.getValueInt("yearly-week-day"),YEARLY_MONTH_2:this.getValueInt("yearly-month-2"),START_DATE:this.getValueString("datepicker-display-start"),END_DATE:this.getValueString("datepicker-display-end"),TIMES:this.getValueInt("end-times"),REPEAT_TILL:this.getRepeatTill()};e.innerHTML=this.makeHintText(t)};this.makeHintText=function(e){var t=null;var a="";var i=BX.message("LANGUAGE_ID");var n="";var r="";var s="";var l="";if(e.PERIOD==this.constants.PERIOD_DAILY){var c=e.EVERY_DAY>1?e.EVERY_DAY+" ":"";if(e.WORKDAY_ONLY=="Y"){a=BX.message("CRM_RECURRING_HINT_ELEMENT_DAY_MASK_WORK").replace("#DAY_NUMBER#",c)}else{a=BX.message("CRM_RECURRING_HINT_ELEMENT_DAY_MASK").replace("#DAY_NUMBER#",c)}}else if(e.PERIOD==this.constants.PERIOD_WEEKLY){t=e.EVERY_WEEK>1?e.EVERY_WEEK+" ":"";if(e.WEEK_DAYS.length==7){weekdays=BX.message("CRM_RECURRING_HINT_WEEKDAY_EVERY_DAY")}else{var E=[];for(var _=0;_<e.WEEK_DAYS.length;_++){E.push(BX.message("CRM_RECURRING_HINT_WEEKDAY_WD_"+e.WEEK_DAYS[_]))}weekdays=E.join(", ")}a=BX.message("CRM_RECURRING_HINT_ELEMENT_WEEKDAY_MASK").replace("#WEEK_NUMBER#",t).replace("#LIST_WEEKDAY_NAMES#",weekdays)}else if(e.PERIOD==this.constants.PERIOD_MONTHLY){var o=null;var h="";if(e.MONTHLY_TYPE==1){t=e.MONTHLY_DAY_NUM;o=e.MONTHLY_MONTH_NUM_1;if(e.MONTHLY_WORKDAY_ONLY=="Y")a=BX.message("CRM_RECURRING_HINT_ELEMENT_MONTH_MASK_1_WORK").replace("#DAY_NUMBER#",t).replace("#MONTH_NUMBER#",o>1?o+" ":"");else a=BX.message("CRM_RECURRING_HINT_ELEMENT_MONTH_MASK_1").replace("#DAY_NUMBER#",t).replace("#MONTH_NUMBER#",o>1?o+" ":"")}else{if(i=="ru"||i=="ua"){r=this.getWeekDayGender(e.MONTHLY_WEEK_DAY)}n=this.getWeekDayName(e.MONTHLY_WEEK_DAY);t=BX.message("CRM_RECURRING_HINT_WEEKDAY_NUMBER_"+e.MONTHLY_WEEK_DAY_NUM+r);h=BX.message("CRM_RECURRING_HINT_EACH"+r);o=e.MONTHLY_MONTH_NUM_2;a=BX.message("CRM_RECURRING_HINT_MONTHLY_EXT_TYPE_2").replace("#EACH#",h).replace("#WEEKDAY_NUMBER#",t).replace("#WEEKDAY_NAME#",n).replace("#MONTH_NUMBER#",o>1?o+" ":"")}}else{var u="";if(e.YEARLY_TYPE==1){t=e.YEARLY_DAY_NUM;u=BX.message("CRM_RECURRING_HINT_MONTH_"+e.YEARLY_MONTH_1);if(e.YEARLY_WORKDAY_ONLY=="Y")a=BX.message("CRM_RECURRING_HINT_YEARLY_EXT_TYPE_1_WORKDAY").replace("#DAY_NUMBER#",t).replace("#MONTH_NAME#",u);else a=BX.message("CRM_RECURRING_HINT_YEARLY_EXT_TYPE_1").replace("#DAY_NUMBER#",t).replace("#MONTH_NAME#",u)}else{if(i=="ru"||i=="ua"){r=this.getWeekDayGender(e.YEARLY_WEEK_DAY)}n=this.getWeekDayName(e.YEARLY_WEEK_DAY);t=BX.message("CRM_RECURRING_HINT_WEEKDAY_NUMBER_"+e.YEARLY_WEEK_DAY_NUM+r);h=BX.message("CRM_RECURRING_HINT_EACH"+r);u=BX.message("CRM_RECURRING_HINT_MONTH_"+e.YEARLY_MONTH_2);a=BX.message("CRM_RECURRING_HINT_YEARLY_EXT_TYPE_2").replace("#EACH#",h).replace("#WEEKDAY_NUMBER#",t).replace("#WEEKDAY_NAME#",n).replace("#MONTH_NAME#",u)}}var d=e.TIMES;if(e.START_DATE!=""){var m=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),BX.parseDate(e.START_DATE,true),false,true);l=BX.message("CRM_RECURRING_HINT_START_DATE").replace("#DATETIME#",m)}else{l=BX.message("CRM_RECURRING_HINT_START_EMPTY")}var g=this.getRepeatTill();if(e.END_DATE!=""&&g==this.constants.REPEAT_TILL_DATE){s=BX.message("CRM_RECURRING_HINT_END").replace("#DATETIME#",e.END_DATE)}else if(d>0&&g==this.constants.REPEAT_TILL_TIMES){s=BX.message("CRM_RECURRING_HINT_END_TIMES").replace("#TIMES#",d).replace("#TIMES_PLURAL#",this.getMessagePlural(d,"CRM_RECURRING_HINT_END_CONSTRAINT_TIMES"))}else{s=BX.message("CRM_RECURRING_HINT_END_NONE")}return BX.message("CRM_RECURRING_HINT_BASE").replace("#ELEMENT#",a).replace("#START#",l).replace("#END#",s)};this.getWeekDayName=function(e){var t="";if(BX.message("LANGUAGE_ID")=="ru"||BX.message("LANGUAGE_ID")=="ua"){t=this.getWeekDayGender(e)}return BX.message("CRM_RECURRING_HINT_WEEKDAY_WD_"+e+(t=="_F"?"_ALT":""))};this.getValueString=function(e){var t=BX(e);if(BX.type.isElementNode(t)){return BX.util.htmlspecialchars(t.value.toString())}return""};this.getValueInt=function(e){var t=BX(e);if(BX.type.isElementNode(t)){var a=parseInt(t.value.toString());if(isNaN(a)){return 0}return a}return 0};this.getMessagePlural=function(e,t){var a,i;i=BX.message("LANGUAGE_ID");e=parseInt(e);if(e<0){e=-1*e}if(i){switch(i){case"de":case"en":a=e!==1?1:0;break;case"ru":case"ua":a=e%10===1&&e%100!==11?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2;break;default:a=1;break}}else{a=1}if(BX.type.isArray(t)){return t[a]}return BX.message(t+"_PLURAL_"+a)};this.getSelectedControlValues=function(e){var t=[];var a=document.getElementsByClassName(e);for(var i in a){if(a[i].checked||a[i].selected){if(t.indexOf(a[i].value)===-1)t.push(a[i].value)}}return t};this.getRepeatTill=function(){var e=this.getSelectedControlValues("selected-end");if(typeof e[0]=="undefined"){return this.constants.REPEAT_TILL_ENDLESS}return e[0]};this.getWeekDays=function(){var e=this.getSelectedControlValues("weekly-week-days");if(e.length==0){e.push(this.constants.MONDAY);document.getElementsByClassName("weekly-week-days")[0].checked=true}else{for(var t=0;t<e.length;t++){e[t]=parseInt(e[t])}}return e};this.getWeekDayGender=function(e){if(e==this.constants.MONDAY||e==this.constants.TUESDAY||e==this.constants.THURSDAY){return"_M"}if(e==this.constants.SUNDAY){return""}return"_F"}}}
//# sourceMappingURL=script.map.js